on:
    push:
  
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  viridian-algae-test-full:
    name: Sample Test
    runs-on: windows-latest

    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4

      - name: Setup WSL
        uses: Vampire/setup-wsl@v5
        with:
          distribution: Ubuntu-24.04
          set-as-default: true
          additional-packages:
            tcpdump

      - name: Post-Configure WSL
        run: |
            $WSL_IP = (wsl -u root hostname -I).Split()[0].Trim()
            $COMPOSE_PATH = (wsl wslpath -a .\\compose.yml).Trim()
            wsl -u root sysctl -w net.ipv4.ip_forward=1
            wsl -u root sh -c "curl -fsSL https://get.docker.com | sh"
            wsl -u root docker compose -f $COMPOSE_PATH up --build --detach
            wsl -u root sleep 30

      - name: TEST STEP
        run: |
          $WSL_IP = (wsl -u root hostname -I).Split()[0].Trim()
          $COMPOSE_PATH = (wsl wslpath -a .\\compose.yml).Trim()
          wsl -u root ping -c 5 10.1.0.42
          wsl -u root ping -c 5 10.1.0.24
          wsl -u root nc -vz 10.1.0.42 80
          wsl -u root nc -vz 10.1.0.24 80
          wsl -u root curl -I 10.1.0.42:80
          wsl -u root curl -I 10.1.0.24:80
